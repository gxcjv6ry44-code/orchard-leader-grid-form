<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Volunteer Entry Grid</title>

  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f6f7f9; margin:0; }
    .wrap { max-width:1200px; margin:20px auto; padding:16px; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; }
    header { padding:14px 16px; border-bottom:1px solid #e5e7eb; }
    header h1 { margin:0 0 6px; font-size:18px; }
    header p { margin:0; font-size:13px; color:#4b5563; }

    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #e5e7eb; padding:8px; }
    th { background:#f3f4f6; font-size:12px; text-align:left; position: sticky; top: 0; }
    .rownum { width:48px; text-align:center; color:#6b7280; background:#fafafa; }

    

    .tableWrap { overflow-x:auto; -webkit-overflow-scrolling:touch; }
    td.details { min-width:520px; }
    .detailsGrid { display:grid; grid-template-columns: repeat(3, minmax(140px, 1fr)); gap:8px; }
    .miniLabel { display:flex; flex-direction:column; gap:4px; font-size:11px; color:#6b7280; }
    .miniLabel input, .miniLabel select { font-size:14px; color:#111827; }

    .optcell { text-align:center; }
    .optcell input[type="checkbox"] { width:18px; height:18px; }

    @media (max-width: 900px) {
      td.details { min-width:320px; }
      .detailsGrid { grid-template-columns: 1fr; }
    }
input, select {
      width:100%;
      padding:8px;
      border:1px solid #d1d5db;
      border-radius:8px;
      font-size:14px;
      box-sizing: border-box;
    }

    .actions { margin-top:14px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    button { padding:10px 14px; border-radius:10px; border:0; font-weight:600; cursor:pointer; }
    .primary { background:#2563eb; color:#fff; }
    .secondary { background:#e5e7eb; }

    .status { font-size:13px; }
    .ok { color:#065f46; }
    .err { color:#991b1b; }

    /* Decoy fields: off-screen but present */
    .decoy {
      position: absolute;
      left: -9999px;
      top: -9999px;
      height: 1px;
      width: 1px;
      opacity: 0;
      pointer-events: none;
    }
  
    .optcell { text-align:center; }
    .optcell input[type="checkbox"] { width:auto; transform: scale(1.1); }

  
    .topSelectors { margin: 0 0 14px 0; padding: 12px; border:1px solid #e5e7eb; border-radius:12px; background:#fbfbfc; }
    .topGrid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .topSelectors label { display:block; font-size:14px; color:#111827; }
    .topSelectors select { width:100%; margin-top:6px; padding:10px 10px; border:1px solid #d1d5db; border-radius:10px; background:#fff; font-size:14px; }
    .hint { margin-top:8px; font-size:12px; color:#6b7280; }
    @media (max-width: 760px) { .topGrid { grid-template-columns: 1fr; } }

  </style>
</head>

<body>
<div class="wrap">
  <div class="card">
    <header>
      <h1>Volunteer Entry Form</h1>
      <p>Fill any rows you need. Empty rows are ignored.</p>
    </header>

    <form id="volForm" autocomplete="off" style="padding:16px; position:relative;">

      <!-- Autofill decoys (most browsers/password managers will fill THESE instead of your grid) -->
      <input class="decoy" type="text"  name="contact_name"  autocomplete="name">
      <input class="decoy" type="email" name="contact_email" autocomplete="email">
      <input class="decoy" type="tel"   name="contact_phone" autocomplete="tel">
      <input class="decoy" type="password" name="password" autocomplete="current-password">

      
      <div class="topSelectors">
        <div class="topGrid">
          <label>Stake
            <select id="stakeTop" name="stakeTop" required>
              <option value="">Select stake</option>
            </select>
          </label>

          <label>Ward
            <select id="wardTop" name="wardTop" required>
              <option value="">Select ward</option>
            </select>
          </label>
        </div>
        <div class="hint">Select the Stake and Ward once. All rows submitted below will use the same Stake and Ward.</div>
      </div>


      <div class="tableWrap">
      <table>
        <thead>
          <tr>
            <th class="rownum">#</th>
            <th>Full Name</th>
            <th>Phone</th>
            <th>Email</th>
            <th>SMS Opt-In</th>
            <th>Details</th>
          </tr>
        </thead>
        <tbody id="grid"></tbody>
      </table>
      </div>

      <div class="actions">
        <button class="primary" type="submit" id="submitBtn">Submit to Make</button>
        <button class="secondary" type="button" id="clearBtn">Clear</button>
        <span id="status" class="status"></span>
      </div>


      <div style="margin-top:16px; padding:12px; border:1px solid #e5e7eb; border-radius:12px; background:#fafafa;">
        <div style="font-weight:700; margin-bottom:6px;">SMS Opt-In Consent</div>
        <div style="font-size:12px; color:#374151; line-height:1.35;">
          By checking the “SMS Opt-In” box for a row, I agree to receive messages sent via an autodialer from North Ogden Orchard, and this agreement isn’t a condition of any purchase.
          I also agree to the Terms of Service and Privacy Policy of about 4 Msgs/Month. Msg &amp; Data rates may apply.
          Text STOP to opt-out. Text HELP for assistance.
          By submitting this form, I agree that my mobile information will not be shared with third parties/affiliates for marketing/promotional purposes.
          All the above categories exclude text messaging originator opt-in data and consent; this information will not be shared with any third parties, except for the necessary opt-in data required to facilitate the SMS service.
        </div>
      </div>

    </form>
  </div>
</div>

<script>
function initVolunteerGrid() {

  const MAKE_WEBHOOK_URL = "https://hook.us2.make.com/k1hui7hlzjbc7guwkssndbhx43u97it1";

const stakeWards = {

  BenLomond: [
    "1st",
    "4th",
    "5th",
    "8th",
    "9th",
    "10th",
    "11th",
    "12th"
  ],

  Hooper: [
    "Hooper 1st",
    "Hooper 2nd",
    "Hooper 3rd",
    "Hooper 4th",
    "Lakeview",
    "Park",
    "Quail Meadows",
    "Homestead",
    "Shannondoah"
  ],

  PerryUtah: [
    "1st",
    "2nd",
    "4th",
    "5th",
    "6th",
    "7th",
    "8th",
    "9th",
    "10th",
    "Box Elder YSA 1st"
  ],

  OgdenMoundFort: [
    "Mill Creek",
    "Heritage Park",
    "Pioneer",
    "Ogden River",
    "Meadowbrook",
    "Adobe Mill"
  ],

  WestHaven: [
    "Rosewood",
    "Olive Bluff",
    "West Haven",
    "Salt Point",
    "Stone Creek",
    "White Rail",
    "Country Meadows"
  ],

  PleasantView: [
    "Pleasant View 1st",
    "Pleasant View 3rd",
    "Pleasant View 4th",
    "Pleasant View 6th",
    "Pleasant View 11th",
    "Pleasant View 12th",
    "Pleasant View 14th",
    "Pleasant View 18th"
  ],

  PlainCity: [
    "Meadows",
    "1st",
    "3rd",
    "4th",
    "5th",
    "6th",
    "9th",
    "Riverside"
  ],

  NorthOgdenEast: [
    "North Ogden 8th",
    "North Ogden 11th",
    "North Ogden 13th",
    "North Ogden 14th",
    "North Ogden 20th",
    "North Ogden 22nd",
    "North Ogden 24th"
  ],

  Kanesville: [
    "Prairie Crossing",
    "Rocky Mountain",
    "Pheasant Meadow",
    "Foxglen Park",
    "Country View",
    "Fair Grove",
    "Regal Country"
  ],

  OgdenWest: [
    "Kanesville",
    "Taylor 1st",
    "Taylor 2nd",
    "Taylor 3rd",
    "Taylor 4th",
    "Taylor 5th",
    "Taylor 6th"
  ],

  HooperUtahPioneerTrail: [
    "Freedom",
    "Fremont",
    "Pioneer Trail",
    "Wildwood",
    "Eastgate",
    "Hooper Landings",
    "Muskrat Springs"
  ],

  WestHavenNorth: [
    "Wilson 2nd",
    "Wilson 3rd",
    "Wilson 4th",
    "Wilson 5th",
    "Riverbend"
  ],

  Willard: [
    "Hargis Hill",
    "Maguire Canyon",
    "Perry 3rd",
    "Three Mile Creek",
    "Willard 1st",
    "Willard 2nd",
    "Willard 3rd",
    "Willard 4th",
    "Willard 5th",
    "Willard 6th"
  ]

};

  const timeMap = {
    "AM Volunteer": "8:30-10:30 AM",
    "PM Volunteer": "5:00-7:00 PM"
  };

  const grid = document.getElementById("grid");
  const stakeTop = document.getElementById("stakeTop");
  const wardTop  = document.getElementById("wardTop");
  const form     = document.getElementById("volForm");

  // If any are missing, stop with a helpful error
  if (!grid || !stakeTop || !wardTop || !form) {
    console.error("Missing required element(s):", { grid, stakeTop, wardTop, form });
    return;
  }

  function populateStakeTop() {
    stakeTop.innerHTML = `<option value="">Select stake</option>` +
      Object.keys(stakeWards).map(s => `<option value="${s}">${s}</option>`).join("");
  }

  function updateWardsTop() {
    const stake = stakeTop.value;
    wardTop.innerHTML = `<option value="">Select ward</option>`;
    (stakeWards[stake] || []).forEach(w => {
      const opt = document.createElement("option");
      opt.value = w;
      opt.textContent = w;
      wardTop.appendChild(opt);
    });
  }

  stakeTop.addEventListener("change", updateWardsTop);
  populateStakeTop();

  const IGNORE_ATTRS = `
    autocomplete="new-password"
    data-lpignore="true"
    data-1p-ignore="true"
    data-bwignore="true"
  `;

  function createRow(i) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="rownum">${i+1}</td>
      <td><input id="fn_${i}" name="fn_${i}" type="text" ${IGNORE_ATTRS} autocapitalize="words" spellcheck="false" /></td>
      <td><input id="ph_${i}" name="ph_${i}" type="tel"  ${IGNORE_ATTRS} inputmode="tel" /></td>
      <td><input id="em_${i}" name="em_${i}" type="email" ${IGNORE_ATTRS} autocapitalize="none" spellcheck="false" inputmode="email" /></td>
      <td class="optcell"><input id="oi_${i}" name="oi_${i}" type="checkbox" aria-label="SMS Opt-In" /></td>

      <td class="details">
        <div class="detailsGrid">
          <label class="miniLabel">Date
            <input id="dt_${i}" name="dt_${i}" type="date" ${IGNORE_ATTRS} />
          </label>

          <label class="miniLabel">Time Slot
            <select id="ts_${i}" name="ts_${i}">
              <option value="">Select</option>
              <option value="AM Volunteer">AM Volunteer</option>
              <option value="PM Volunteer">PM Volunteer</option>
            </select>
          </label>

          <label class="miniLabel">Time Range
            <select id="tr_${i}" name="tr_${i}">
              <option value="">Select</option>
              <option value="8:30-10:30 AM">8:30-10:30 AM</option>
              <option value="5:00-7:00 PM">5:00-7:00 PM</option>
            </select>
          </label>
        </div>
      </td>
    `;
    tr.querySelector(`#ts_${i}`).addEventListener("change", () => {
      const ts = document.getElementById(`ts_${i}`).value;
      document.getElementById(`tr_${i}`).value = timeMap[ts] || "";
    });
    return tr;
  }

  // Render 8 rows
  grid.innerHTML = "";
  for (let i=0; i<8; i++) grid.appendChild(createRow(i));

  const v = (id) => (document.getElementById(id).value || "").trim();
  const c = (id) => !!document.getElementById(id).checked;

  const digitsOnly = (s) => (s || "").replace(/\D/g, "");
  const norm = (s) => (s || "").toLowerCase().trim().replace(/\s+/g, " ");

  function buildDedupeKey({ stake, ward, fullName, phone, date, timeslot }) {
    return [
      norm(stake),
      norm(ward),
      norm(fullName),
      digitsOnly(phone),
      (date || "").trim(),
      norm(timeslot),
    ].join("|");
  }

  function collectRows() {
    const rows = [];
    for (let i=0; i<8; i++) {
      const stake = v("stakeTop");
      const ward  = v("wardTop");

      const rBase = {
        row: i+1,
        fullName: v(`fn_${i}`),
        phone: v(`ph_${i}`),
        email: v(`em_${i}`),
        stake,
        ward,
        date: v(`dt_${i}`),
        timeslot: v(`ts_${i}`),
        timerange: v(`tr_${i}`)
      };

      const r = {
        ...rBase,
        dedupeKey: buildDedupeKey(rBase),
        optIn: c(`oi_${i}`) // keep last
      };

      const hasAny = Object.entries(r).some(([k,val]) =>
        !["row","optIn","stake","ward","dedupeKey"].includes(k) && val
      );
      if (hasAny) rows.push(r);
    }
    return rows;
  }

  function setStatus(msg, cls="") {
    const s = document.getElementById("status");
    s.textContent = msg;
    s.className = `status ${cls}`;
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    if (!v("stakeTop")) { setStatus("Select a Stake at the top of the form.", "err"); return; }
    if (!v("wardTop"))  { setStatus("Select a Ward at the top of the form.", "err"); return; }

    const rows = collectRows();
    if (!rows.length) { setStatus("No data to submit.", "err"); return; }

    setStatus("Submitting…");
    try {
      const res = await fetch(MAKE_WEBHOOK_URL, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ submittedAt: new Date().toISOString(), rows })
      });

      const text = await res.text();
      if (res.ok) {
        setStatus(`Submitted ${rows.length} row(s).`, "ok");
        document.getElementById("clearBtn").click(); // auto-clear after success
      } else {
        setStatus(`Submit failed (${res.status}): ${text}`, "err");
      }
    } catch (err) {
      setStatus(`Submit failed: ${err.message || err}`, "err");
    }
  });

  document.getElementById("clearBtn").addEventListener("click", () => {
    for (let i=0; i<8; i++) {
      ["fn","ph","em","dt"].forEach(p => document.getElementById(`${p}_${i}`).value = "");
      document.getElementById(`oi_${i}`).checked = false;
      ["ts","tr"].forEach(p => document.getElementById(`${p}_${i}`).value = "");
    }
    setStatus("");
  });

}

// Run init reliably, even if DOMContentLoaded already fired
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", initVolunteerGrid);
} else {
  initVolunteerGrid();
}
</script>
</body>
</html>
